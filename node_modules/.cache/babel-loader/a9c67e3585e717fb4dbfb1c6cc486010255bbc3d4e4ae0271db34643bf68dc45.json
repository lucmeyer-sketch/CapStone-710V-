{"ast":null,"code":"import { supabase } from '../supabaseClient';\n/**\r\n * Iniciar sesión con email y contraseña\r\n * NOTA: En producción, las contraseñas deben estar hasheadas\r\n */\nexport const login = async (email, password) => {\n  try {\n    // buscar usuario por email\n    const {\n      data: usuario,\n      error: usuarioError\n    } = await supabase.from('usuarios').select('*').eq('email', email.toLowerCase().trim()).eq('activo', true).single();\n    if (usuarioError || !usuario) {\n      return {\n        success: false,\n        error: 'Credenciales incorrectas'\n      };\n    }\n\n    // verificar contraseña (NOTA: en producción usar bcrypt)\n    // por ahora comparación simple\n    if (usuario.password_hash !== password) {\n      return {\n        success: false,\n        error: 'Credenciales incorrectas'\n      };\n    }\n\n    // actualizar último acceso\n    await supabase.from('usuarios').update({\n      ultimo_acceso: new Date().toISOString()\n    }).eq('id', usuario.id);\n\n    // obtener detalles según el rol\n    let detalles = null;\n    if (usuario.rol === 'estudiante') {\n      const {\n        data: estudiante\n      } = await supabase.from('Estudiantes').select('id, nombre, apellido, telefono, grado, seccion').eq('usuario_id', usuario.id).single();\n      detalles = estudiante;\n    } else if (usuario.rol === 'docente') {\n      const {\n        data: docente\n      } = await supabase.from('docentes').select('id, nombre, apellido, telefono, especialidad').eq('usuario_id', usuario.id).single();\n      detalles = docente;\n    }\n    return {\n      success: true,\n      usuario: {\n        ...usuario,\n        detalles\n      }\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: 'Error al iniciar sesión: ' + error.message\n    };\n  }\n};\n\n/**\r\n * Obtener usuario por ID\r\n */\nexport const getUsuarioById = async id => {\n  try {\n    const {\n      data: usuario,\n      error\n    } = await supabase.from('usuarios').select('*').eq('id', id).single();\n    if (error || !usuario) return null;\n\n    // obtener detalles según el rol\n    let detalles = null;\n    if (usuario.rol === 'estudiante') {\n      const {\n        data: estudiante\n      } = await supabase.from('Estudiantes').select('id, nombre, apellido, telefono, grado, seccion').eq('usuario_id', usuario.id).single();\n      detalles = estudiante;\n    } else if (usuario.rol === 'docente') {\n      const {\n        data: docente\n      } = await supabase.from('docentes').select('id, nombre, apellido, telefono, especialidad').eq('usuario_id', usuario.id).single();\n      detalles = docente;\n    }\n    return {\n      ...usuario,\n      detalles\n    };\n  } catch (error) {\n    return null;\n  }\n};\n\n/**\r\n * Verificar si un email ya existe\r\n */\nexport const emailExists = async email => {\n  const {\n    data,\n    error\n  } = await supabase.from('usuarios').select('id').eq('email', email.toLowerCase().trim()).single();\n  return !error && data !== null;\n};\n\n/**\r\n * Cambiar contraseña\r\n */\nexport const cambiarPassword = async (usuarioId, passwordActual, passwordNueva) => {\n  try {\n    // verificar contraseña actual\n    const {\n      data: usuario,\n      error\n    } = await supabase.from('usuarios').select('password_hash').eq('id', usuarioId).single();\n    if (error || !usuario) {\n      return {\n        success: false,\n        error: 'Usuario no encontrado'\n      };\n    }\n    if (usuario.password_hash !== passwordActual) {\n      return {\n        success: false,\n        error: 'Contraseña actual incorrecta'\n      };\n    }\n\n    // actualizar contraseña\n    const {\n      error: updateError\n    } = await supabase.from('usuarios').update({\n      password_hash: passwordNueva\n    }).eq('id', usuarioId);\n    if (updateError) {\n      return {\n        success: false,\n        error: 'Error al actualizar contraseña'\n      };\n    }\n    return {\n      success: true\n    };\n  } catch (error) {\n    return {\n      success: false,\n      error: error.message\n    };\n  }\n};\n\n/**\r\n * Crear sesión (opcional, para tracking)\r\n */\nexport const crearSesion = async (usuarioId, token, duracionHoras = 24) => {\n  const expiraEn = new Date();\n  expiraEn.setHours(expiraEn.getHours() + duracionHoras);\n  await supabase.from('sesiones').insert({\n    usuario_id: usuarioId,\n    token,\n    expira_en: expiraEn.toISOString()\n  });\n};\n\n/**\r\n * Cerrar sesión (limpiar sesiones)\r\n */\nexport const logout = async usuarioId => {\n  // eliminar sesiones expiradas o del usuario\n  await supabase.from('sesiones').delete().eq('usuario_id', usuarioId);\n};\n\n/**\r\n * Obtener todos los usuarios (admin)\r\n */\nexport const getAllUsuarios = async () => {\n  const {\n    data,\n    error\n  } = await supabase.from('usuarios').select('*').order('rol', {\n    ascending: true\n  }).order('email', {\n    ascending: true\n  });\n  if (error) throw error;\n  return data || [];\n};","map":{"version":3,"names":["supabase","login","email","password","data","usuario","error","usuarioError","from","select","eq","toLowerCase","trim","single","success","password_hash","update","ultimo_acceso","Date","toISOString","id","detalles","rol","estudiante","docente","message","getUsuarioById","emailExists","cambiarPassword","usuarioId","passwordActual","passwordNueva","updateError","crearSesion","token","duracionHoras","expiraEn","setHours","getHours","insert","usuario_id","expira_en","logout","delete","getAllUsuarios","order","ascending"],"sources":["C:/Users/diego/OneDrive/Escritorio/ProyectoAPT/CapStone-710V-/src/services/authService.ts"],"sourcesContent":["import { supabase } from '../supabaseClient';\r\n\r\nexport interface Usuario {\r\n  id: number;\r\n  email: string;\r\n  rol: 'estudiante' | 'docente' | 'admin' | 'psicologo' | 'director';\r\n  activo: boolean;\r\n  ultimo_acceso?: string;\r\n  created_at?: string;\r\n}\r\n\r\nexport interface UsuarioConDetalles extends Usuario {\r\n  detalles?: {\r\n    id: number;\r\n    nombre: string;\r\n    apellido: string;\r\n    telefono?: string;\r\n    grado?: string;\r\n    seccion?: string;\r\n    especialidad?: string;\r\n  };\r\n}\r\n\r\nexport interface LoginResponse {\r\n  success: boolean;\r\n  usuario?: UsuarioConDetalles;\r\n  error?: string;\r\n}\r\n\r\n/**\r\n * Iniciar sesión con email y contraseña\r\n * NOTA: En producción, las contraseñas deben estar hasheadas\r\n */\r\nexport const login = async (email: string, password: string): Promise<LoginResponse> => {\r\n  try {\r\n    // buscar usuario por email\r\n    const { data: usuario, error: usuarioError } = await supabase\r\n      .from('usuarios')\r\n      .select('*')\r\n      .eq('email', email.toLowerCase().trim())\r\n      .eq('activo', true)\r\n      .single();\r\n\r\n    if (usuarioError || !usuario) {\r\n      return {\r\n        success: false,\r\n        error: 'Credenciales incorrectas'\r\n      };\r\n    }\r\n\r\n    // verificar contraseña (NOTA: en producción usar bcrypt)\r\n    // por ahora comparación simple\r\n    if (usuario.password_hash !== password) {\r\n      return {\r\n        success: false,\r\n        error: 'Credenciales incorrectas'\r\n      };\r\n    }\r\n\r\n    // actualizar último acceso\r\n    await supabase\r\n      .from('usuarios')\r\n      .update({ ultimo_acceso: new Date().toISOString() })\r\n      .eq('id', usuario.id);\r\n\r\n    // obtener detalles según el rol\r\n    let detalles = null;\r\n\r\n    if (usuario.rol === 'estudiante') {\r\n      const { data: estudiante } = await supabase\r\n        .from('Estudiantes')\r\n        .select('id, nombre, apellido, telefono, grado, seccion')\r\n        .eq('usuario_id', usuario.id)\r\n        .single();\r\n      \r\n      detalles = estudiante;\r\n    } else if (usuario.rol === 'docente') {\r\n      const { data: docente } = await supabase\r\n        .from('docentes')\r\n        .select('id, nombre, apellido, telefono, especialidad')\r\n        .eq('usuario_id', usuario.id)\r\n        .single();\r\n      \r\n      detalles = docente;\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      usuario: {\r\n        ...usuario,\r\n        detalles\r\n      }\r\n    };\r\n\r\n  } catch (error: any) {\r\n    return {\r\n      success: false,\r\n      error: 'Error al iniciar sesión: ' + error.message\r\n    };\r\n  }\r\n};\r\n\r\n/**\r\n * Obtener usuario por ID\r\n */\r\nexport const getUsuarioById = async (id: number): Promise<UsuarioConDetalles | null> => {\r\n  try {\r\n    const { data: usuario, error } = await supabase\r\n      .from('usuarios')\r\n      .select('*')\r\n      .eq('id', id)\r\n      .single();\r\n\r\n    if (error || !usuario) return null;\r\n\r\n    // obtener detalles según el rol\r\n    let detalles = null;\r\n\r\n    if (usuario.rol === 'estudiante') {\r\n      const { data: estudiante } = await supabase\r\n        .from('Estudiantes')\r\n        .select('id, nombre, apellido, telefono, grado, seccion')\r\n        .eq('usuario_id', usuario.id)\r\n        .single();\r\n      \r\n      detalles = estudiante;\r\n    } else if (usuario.rol === 'docente') {\r\n      const { data: docente } = await supabase\r\n        .from('docentes')\r\n        .select('id, nombre, apellido, telefono, especialidad')\r\n        .eq('usuario_id', usuario.id)\r\n        .single();\r\n      \r\n      detalles = docente;\r\n    }\r\n\r\n    return {\r\n      ...usuario,\r\n      detalles\r\n    };\r\n\r\n  } catch (error) {\r\n    return null;\r\n  }\r\n};\r\n\r\n/**\r\n * Verificar si un email ya existe\r\n */\r\nexport const emailExists = async (email: string): Promise<boolean> => {\r\n  const { data, error } = await supabase\r\n    .from('usuarios')\r\n    .select('id')\r\n    .eq('email', email.toLowerCase().trim())\r\n    .single();\r\n\r\n  return !error && data !== null;\r\n};\r\n\r\n/**\r\n * Cambiar contraseña\r\n */\r\nexport const cambiarPassword = async (\r\n  usuarioId: number,\r\n  passwordActual: string,\r\n  passwordNueva: string\r\n): Promise<{ success: boolean; error?: string }> => {\r\n  try {\r\n    // verificar contraseña actual\r\n    const { data: usuario, error } = await supabase\r\n      .from('usuarios')\r\n      .select('password_hash')\r\n      .eq('id', usuarioId)\r\n      .single();\r\n\r\n    if (error || !usuario) {\r\n      return { success: false, error: 'Usuario no encontrado' };\r\n    }\r\n\r\n    if (usuario.password_hash !== passwordActual) {\r\n      return { success: false, error: 'Contraseña actual incorrecta' };\r\n    }\r\n\r\n    // actualizar contraseña\r\n    const { error: updateError } = await supabase\r\n      .from('usuarios')\r\n      .update({ password_hash: passwordNueva })\r\n      .eq('id', usuarioId);\r\n\r\n    if (updateError) {\r\n      return { success: false, error: 'Error al actualizar contraseña' };\r\n    }\r\n\r\n    return { success: true };\r\n\r\n  } catch (error: any) {\r\n    return { success: false, error: error.message };\r\n  }\r\n};\r\n\r\n/**\r\n * Crear sesión (opcional, para tracking)\r\n */\r\nexport const crearSesion = async (\r\n  usuarioId: number,\r\n  token: string,\r\n  duracionHoras: number = 24\r\n): Promise<void> => {\r\n  const expiraEn = new Date();\r\n  expiraEn.setHours(expiraEn.getHours() + duracionHoras);\r\n\r\n  await supabase.from('sesiones').insert({\r\n    usuario_id: usuarioId,\r\n    token,\r\n    expira_en: expiraEn.toISOString()\r\n  });\r\n};\r\n\r\n/**\r\n * Cerrar sesión (limpiar sesiones)\r\n */\r\nexport const logout = async (usuarioId: number): Promise<void> => {\r\n  // eliminar sesiones expiradas o del usuario\r\n  await supabase\r\n    .from('sesiones')\r\n    .delete()\r\n    .eq('usuario_id', usuarioId);\r\n};\r\n\r\n/**\r\n * Obtener todos los usuarios (admin)\r\n */\r\nexport const getAllUsuarios = async (): Promise<Usuario[]> => {\r\n  const { data, error } = await supabase\r\n    .from('usuarios')\r\n    .select('*')\r\n    .order('rol', { ascending: true })\r\n    .order('email', { ascending: true });\r\n\r\n  if (error) throw error;\r\n  return data || [];\r\n};\r\n\r\n"],"mappings":"AAAA,SAASA,QAAQ,QAAQ,mBAAmB;AA6B5C;AACA;AACA;AACA;AACA,OAAO,MAAMC,KAAK,GAAG,MAAAA,CAAOC,KAAa,EAAEC,QAAgB,KAA6B;EACtF,IAAI;IACF;IACA,MAAM;MAAEC,IAAI,EAAEC,OAAO;MAAEC,KAAK,EAAEC;IAAa,CAAC,GAAG,MAAMP,QAAQ,CAC1DQ,IAAI,CAAC,UAAU,CAAC,CAChBC,MAAM,CAAC,GAAG,CAAC,CACXC,EAAE,CAAC,OAAO,EAAER,KAAK,CAACS,WAAW,CAAC,CAAC,CAACC,IAAI,CAAC,CAAC,CAAC,CACvCF,EAAE,CAAC,QAAQ,EAAE,IAAI,CAAC,CAClBG,MAAM,CAAC,CAAC;IAEX,IAAIN,YAAY,IAAI,CAACF,OAAO,EAAE;MAC5B,OAAO;QACLS,OAAO,EAAE,KAAK;QACdR,KAAK,EAAE;MACT,CAAC;IACH;;IAEA;IACA;IACA,IAAID,OAAO,CAACU,aAAa,KAAKZ,QAAQ,EAAE;MACtC,OAAO;QACLW,OAAO,EAAE,KAAK;QACdR,KAAK,EAAE;MACT,CAAC;IACH;;IAEA;IACA,MAAMN,QAAQ,CACXQ,IAAI,CAAC,UAAU,CAAC,CAChBQ,MAAM,CAAC;MAAEC,aAAa,EAAE,IAAIC,IAAI,CAAC,CAAC,CAACC,WAAW,CAAC;IAAE,CAAC,CAAC,CACnDT,EAAE,CAAC,IAAI,EAAEL,OAAO,CAACe,EAAE,CAAC;;IAEvB;IACA,IAAIC,QAAQ,GAAG,IAAI;IAEnB,IAAIhB,OAAO,CAACiB,GAAG,KAAK,YAAY,EAAE;MAChC,MAAM;QAAElB,IAAI,EAAEmB;MAAW,CAAC,GAAG,MAAMvB,QAAQ,CACxCQ,IAAI,CAAC,aAAa,CAAC,CACnBC,MAAM,CAAC,gDAAgD,CAAC,CACxDC,EAAE,CAAC,YAAY,EAAEL,OAAO,CAACe,EAAE,CAAC,CAC5BP,MAAM,CAAC,CAAC;MAEXQ,QAAQ,GAAGE,UAAU;IACvB,CAAC,MAAM,IAAIlB,OAAO,CAACiB,GAAG,KAAK,SAAS,EAAE;MACpC,MAAM;QAAElB,IAAI,EAAEoB;MAAQ,CAAC,GAAG,MAAMxB,QAAQ,CACrCQ,IAAI,CAAC,UAAU,CAAC,CAChBC,MAAM,CAAC,8CAA8C,CAAC,CACtDC,EAAE,CAAC,YAAY,EAAEL,OAAO,CAACe,EAAE,CAAC,CAC5BP,MAAM,CAAC,CAAC;MAEXQ,QAAQ,GAAGG,OAAO;IACpB;IAEA,OAAO;MACLV,OAAO,EAAE,IAAI;MACbT,OAAO,EAAE;QACP,GAAGA,OAAO;QACVgB;MACF;IACF,CAAC;EAEH,CAAC,CAAC,OAAOf,KAAU,EAAE;IACnB,OAAO;MACLQ,OAAO,EAAE,KAAK;MACdR,KAAK,EAAE,2BAA2B,GAAGA,KAAK,CAACmB;IAC7C,CAAC;EACH;AACF,CAAC;;AAED;AACA;AACA;AACA,OAAO,MAAMC,cAAc,GAAG,MAAON,EAAU,IAAyC;EACtF,IAAI;IACF,MAAM;MAAEhB,IAAI,EAAEC,OAAO;MAAEC;IAAM,CAAC,GAAG,MAAMN,QAAQ,CAC5CQ,IAAI,CAAC,UAAU,CAAC,CAChBC,MAAM,CAAC,GAAG,CAAC,CACXC,EAAE,CAAC,IAAI,EAAEU,EAAE,CAAC,CACZP,MAAM,CAAC,CAAC;IAEX,IAAIP,KAAK,IAAI,CAACD,OAAO,EAAE,OAAO,IAAI;;IAElC;IACA,IAAIgB,QAAQ,GAAG,IAAI;IAEnB,IAAIhB,OAAO,CAACiB,GAAG,KAAK,YAAY,EAAE;MAChC,MAAM;QAAElB,IAAI,EAAEmB;MAAW,CAAC,GAAG,MAAMvB,QAAQ,CACxCQ,IAAI,CAAC,aAAa,CAAC,CACnBC,MAAM,CAAC,gDAAgD,CAAC,CACxDC,EAAE,CAAC,YAAY,EAAEL,OAAO,CAACe,EAAE,CAAC,CAC5BP,MAAM,CAAC,CAAC;MAEXQ,QAAQ,GAAGE,UAAU;IACvB,CAAC,MAAM,IAAIlB,OAAO,CAACiB,GAAG,KAAK,SAAS,EAAE;MACpC,MAAM;QAAElB,IAAI,EAAEoB;MAAQ,CAAC,GAAG,MAAMxB,QAAQ,CACrCQ,IAAI,CAAC,UAAU,CAAC,CAChBC,MAAM,CAAC,8CAA8C,CAAC,CACtDC,EAAE,CAAC,YAAY,EAAEL,OAAO,CAACe,EAAE,CAAC,CAC5BP,MAAM,CAAC,CAAC;MAEXQ,QAAQ,GAAGG,OAAO;IACpB;IAEA,OAAO;MACL,GAAGnB,OAAO;MACVgB;IACF,CAAC;EAEH,CAAC,CAAC,OAAOf,KAAK,EAAE;IACd,OAAO,IAAI;EACb;AACF,CAAC;;AAED;AACA;AACA;AACA,OAAO,MAAMqB,WAAW,GAAG,MAAOzB,KAAa,IAAuB;EACpE,MAAM;IAAEE,IAAI;IAAEE;EAAM,CAAC,GAAG,MAAMN,QAAQ,CACnCQ,IAAI,CAAC,UAAU,CAAC,CAChBC,MAAM,CAAC,IAAI,CAAC,CACZC,EAAE,CAAC,OAAO,EAAER,KAAK,CAACS,WAAW,CAAC,CAAC,CAACC,IAAI,CAAC,CAAC,CAAC,CACvCC,MAAM,CAAC,CAAC;EAEX,OAAO,CAACP,KAAK,IAAIF,IAAI,KAAK,IAAI;AAChC,CAAC;;AAED;AACA;AACA;AACA,OAAO,MAAMwB,eAAe,GAAG,MAAAA,CAC7BC,SAAiB,EACjBC,cAAsB,EACtBC,aAAqB,KAC6B;EAClD,IAAI;IACF;IACA,MAAM;MAAE3B,IAAI,EAAEC,OAAO;MAAEC;IAAM,CAAC,GAAG,MAAMN,QAAQ,CAC5CQ,IAAI,CAAC,UAAU,CAAC,CAChBC,MAAM,CAAC,eAAe,CAAC,CACvBC,EAAE,CAAC,IAAI,EAAEmB,SAAS,CAAC,CACnBhB,MAAM,CAAC,CAAC;IAEX,IAAIP,KAAK,IAAI,CAACD,OAAO,EAAE;MACrB,OAAO;QAAES,OAAO,EAAE,KAAK;QAAER,KAAK,EAAE;MAAwB,CAAC;IAC3D;IAEA,IAAID,OAAO,CAACU,aAAa,KAAKe,cAAc,EAAE;MAC5C,OAAO;QAAEhB,OAAO,EAAE,KAAK;QAAER,KAAK,EAAE;MAA+B,CAAC;IAClE;;IAEA;IACA,MAAM;MAAEA,KAAK,EAAE0B;IAAY,CAAC,GAAG,MAAMhC,QAAQ,CAC1CQ,IAAI,CAAC,UAAU,CAAC,CAChBQ,MAAM,CAAC;MAAED,aAAa,EAAEgB;IAAc,CAAC,CAAC,CACxCrB,EAAE,CAAC,IAAI,EAAEmB,SAAS,CAAC;IAEtB,IAAIG,WAAW,EAAE;MACf,OAAO;QAAElB,OAAO,EAAE,KAAK;QAAER,KAAK,EAAE;MAAiC,CAAC;IACpE;IAEA,OAAO;MAAEQ,OAAO,EAAE;IAAK,CAAC;EAE1B,CAAC,CAAC,OAAOR,KAAU,EAAE;IACnB,OAAO;MAAEQ,OAAO,EAAE,KAAK;MAAER,KAAK,EAAEA,KAAK,CAACmB;IAAQ,CAAC;EACjD;AACF,CAAC;;AAED;AACA;AACA;AACA,OAAO,MAAMQ,WAAW,GAAG,MAAAA,CACzBJ,SAAiB,EACjBK,KAAa,EACbC,aAAqB,GAAG,EAAE,KACR;EAClB,MAAMC,QAAQ,GAAG,IAAIlB,IAAI,CAAC,CAAC;EAC3BkB,QAAQ,CAACC,QAAQ,CAACD,QAAQ,CAACE,QAAQ,CAAC,CAAC,GAAGH,aAAa,CAAC;EAEtD,MAAMnC,QAAQ,CAACQ,IAAI,CAAC,UAAU,CAAC,CAAC+B,MAAM,CAAC;IACrCC,UAAU,EAAEX,SAAS;IACrBK,KAAK;IACLO,SAAS,EAAEL,QAAQ,CAACjB,WAAW,CAAC;EAClC,CAAC,CAAC;AACJ,CAAC;;AAED;AACA;AACA;AACA,OAAO,MAAMuB,MAAM,GAAG,MAAOb,SAAiB,IAAoB;EAChE;EACA,MAAM7B,QAAQ,CACXQ,IAAI,CAAC,UAAU,CAAC,CAChBmC,MAAM,CAAC,CAAC,CACRjC,EAAE,CAAC,YAAY,EAAEmB,SAAS,CAAC;AAChC,CAAC;;AAED;AACA;AACA;AACA,OAAO,MAAMe,cAAc,GAAG,MAAAA,CAAA,KAAgC;EAC5D,MAAM;IAAExC,IAAI;IAAEE;EAAM,CAAC,GAAG,MAAMN,QAAQ,CACnCQ,IAAI,CAAC,UAAU,CAAC,CAChBC,MAAM,CAAC,GAAG,CAAC,CACXoC,KAAK,CAAC,KAAK,EAAE;IAAEC,SAAS,EAAE;EAAK,CAAC,CAAC,CACjCD,KAAK,CAAC,OAAO,EAAE;IAAEC,SAAS,EAAE;EAAK,CAAC,CAAC;EAEtC,IAAIxC,KAAK,EAAE,MAAMA,KAAK;EACtB,OAAOF,IAAI,IAAI,EAAE;AACnB,CAAC","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}