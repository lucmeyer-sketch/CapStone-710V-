{"ast":null,"code":"import { supabase } from '../supabaseClient';\nimport { getClasesByDocente } from './claseService';\nimport { getPromedioGeneralEstudiante } from './calificacionService';\n// obtener estadísticas del dashboard para un docente específico\nexport const getEstadisticasDashboardDocente = async docenteId => {\n  try {\n    // 1) Obtener clases del docente\n    const clases = await getClasesByDocente(docenteId.toString());\n    const claseIds = clases.map(c => c.id);\n    if (claseIds.length === 0) {\n      return {\n        totalEstudiantes: 0,\n        totalClases: 0,\n        tasaAsistencia: 0,\n        promedioGeneral: 0,\n        mensajesNoLeidos: 0,\n        clasesHoy: 0,\n        estudiantesRecientes: 0,\n        calificacionesPendientes: 0\n      };\n    }\n\n    // 2) Obtener estudiantes inscritos en sus clases\n    const {\n      data: inscripciones,\n      error: inscripcionesError\n    } = await supabase.from('inscripciones').select('estudiante_id').in('clase_id', claseIds).eq('estado', 'activo');\n    if (inscripcionesError) throw inscripcionesError;\n    const estudianteIds = Array.from(new Set((inscripciones === null || inscripciones === void 0 ? void 0 : inscripciones.map(i => i.estudiante_id)) || []));\n    const totalEstudiantes = estudianteIds.length;\n\n    // 3) Calcular tasa de asistencia promedio (últimos 30 días) - solo de las clases del docente\n    const hace30Dias = new Date();\n    hace30Dias.setDate(hace30Dias.getDate() - 30);\n    const fechaInicio = hace30Dias.toISOString().split('T')[0];\n    const fechaFin = new Date().toISOString().split('T')[0];\n    let tasaAsistencia = 0;\n    if (estudianteIds.length > 0 && claseIds.length > 0) {\n      // Obtener todas las asistencias de los estudiantes en las clases del docente\n      const {\n        data: asistencias,\n        error: asistenciasError\n      } = await supabase.from('asistencia').select('estado').in('estudiante_id', estudianteIds).in('clase_id', claseIds).gte('fecha', fechaInicio).lte('fecha', fechaFin);\n      if (!asistenciasError && asistencias && asistencias.length > 0) {\n        const total = asistencias.length;\n        const presentes = asistencias.filter(a => a.estado === 'presente' || a.estado === 'tarde').length;\n        tasaAsistencia = presentes / total * 100;\n      }\n    }\n\n    // 4) Calcular promedio general de calificaciones de sus estudiantes\n    let promedioGeneral = 0;\n    if (estudianteIds.length > 0) {\n      const promedios = await Promise.all(estudianteIds.map(async estId => {\n        try {\n          return await getPromedioGeneralEstudiante(estId.toString());\n        } catch {\n          return 0;\n        }\n      }));\n      const promediosValidos = promedios.filter(p => p > 0);\n      if (promediosValidos.length > 0) {\n        const suma = promediosValidos.reduce((acc, p) => acc + p, 0);\n        promedioGeneral = suma / promediosValidos.length;\n      }\n    }\n\n    // 5) Mensajes no leídos dirigidos al docente\n    const {\n      count: mensajesNoLeidos\n    } = await supabase.from('mensajes').select('*', {\n      count: 'exact',\n      head: true\n    }).eq('destinatario_tipo', 'docente').eq('destinatario_id', docenteId).eq('leido', false);\n\n    // 6) Clases de hoy (basado en horario - simplificado: contar clases activas)\n    const hoy = new Date();\n    const diaSemana = ['domingo', 'lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado'][hoy.getDay()];\n    // Por ahora, contamos todas las clases activas (podríamos mejorar esto con horarios reales)\n    const clasesHoy = clases.filter(c => c.estado === 'activo').length;\n\n    // 7) Estudiantes con actividad reciente (últimos 7 días)\n    const hace7Dias = new Date();\n    hace7Dias.setDate(hace7Dias.getDate() - 7);\n    const {\n      data: asistenciasRecientes\n    } = await supabase.from('asistencia').select('estudiante_id').in('clase_id', claseIds).gte('fecha', hace7Dias.toISOString().split('T')[0]);\n    const estudiantesRecientes = new Set((asistenciasRecientes === null || asistenciasRecientes === void 0 ? void 0 : asistenciasRecientes.map(a => a.estudiante_id)) || []).size;\n\n    // 8) Calificaciones pendientes (estudiantes sin calificaciones recientes)\n    // Por ahora, retornamos 0 (podríamos implementar lógica más compleja)\n    const calificacionesPendientes = 0;\n    return {\n      totalEstudiantes,\n      totalClases: clases.length,\n      tasaAsistencia: Math.round(tasaAsistencia * 10) / 10,\n      promedioGeneral: Math.round(promedioGeneral * 10) / 10,\n      mensajesNoLeidos: mensajesNoLeidos || 0,\n      clasesHoy,\n      estudiantesRecientes,\n      calificacionesPendientes\n    };\n  } catch (error) {\n    console.error('Error al obtener estadísticas del docente:', error);\n    throw error;\n  }\n};","map":{"version":3,"names":["supabase","getClasesByDocente","getPromedioGeneralEstudiante","getEstadisticasDashboardDocente","docenteId","clases","toString","claseIds","map","c","id","length","totalEstudiantes","totalClases","tasaAsistencia","promedioGeneral","mensajesNoLeidos","clasesHoy","estudiantesRecientes","calificacionesPendientes","data","inscripciones","error","inscripcionesError","from","select","in","eq","estudianteIds","Array","Set","i","estudiante_id","hace30Dias","Date","setDate","getDate","fechaInicio","toISOString","split","fechaFin","asistencias","asistenciasError","gte","lte","total","presentes","filter","a","estado","promedios","Promise","all","estId","promediosValidos","p","suma","reduce","acc","count","head","hoy","diaSemana","getDay","hace7Dias","asistenciasRecientes","size","Math","round","console"],"sources":["C:/Users/diego/OneDrive/Escritorio/ProyectoAPT/CapStone-710V-/Proyecto/src/services/dashboardService.ts"],"sourcesContent":["import { supabase } from '../supabaseClient';\r\nimport { getClasesByDocente } from './claseService';\r\nimport { getPorcentajeAsistenciaEstudiante } from './asistenciaService';\r\nimport { getPromedioGeneralEstudiante } from './calificacionService';\r\n\r\nexport interface EstadisticasDashboardDocente {\r\n  totalEstudiantes: number; // Estudiantes en sus clases\r\n  totalClases: number; // Clases asignadas\r\n  tasaAsistencia: number; // Promedio de asistencia de sus estudiantes\r\n  promedioGeneral: number; // Promedio general de calificaciones de sus estudiantes\r\n  mensajesNoLeidos: number; // Mensajes no leídos dirigidos al docente\r\n  clasesHoy: number; // Clases que tiene hoy\r\n  estudiantesRecientes: number; // Estudiantes con actividad reciente\r\n  calificacionesPendientes: number; // Calificaciones pendientes de ingresar\r\n}\r\n\r\n// obtener estadísticas del dashboard para un docente específico\r\nexport const getEstadisticasDashboardDocente = async (\r\n  docenteId: number\r\n): Promise<EstadisticasDashboardDocente> => {\r\n  try {\r\n    // 1) Obtener clases del docente\r\n    const clases = await getClasesByDocente(docenteId.toString());\r\n    const claseIds = clases.map(c => c.id);\r\n\r\n    if (claseIds.length === 0) {\r\n      return {\r\n        totalEstudiantes: 0,\r\n        totalClases: 0,\r\n        tasaAsistencia: 0,\r\n        promedioGeneral: 0,\r\n        mensajesNoLeidos: 0,\r\n        clasesHoy: 0,\r\n        estudiantesRecientes: 0,\r\n        calificacionesPendientes: 0\r\n      };\r\n    }\r\n\r\n    // 2) Obtener estudiantes inscritos en sus clases\r\n    const { data: inscripciones, error: inscripcionesError } = await supabase\r\n      .from('inscripciones')\r\n      .select('estudiante_id')\r\n      .in('clase_id', claseIds)\r\n      .eq('estado', 'activo');\r\n\r\n    if (inscripcionesError) throw inscripcionesError;\r\n\r\n    const estudianteIds = Array.from(\r\n      new Set(inscripciones?.map(i => i.estudiante_id) || [])\r\n    );\r\n    const totalEstudiantes = estudianteIds.length;\r\n\r\n    // 3) Calcular tasa de asistencia promedio (últimos 30 días) - solo de las clases del docente\r\n    const hace30Dias = new Date();\r\n    hace30Dias.setDate(hace30Dias.getDate() - 30);\r\n    const fechaInicio = hace30Dias.toISOString().split('T')[0];\r\n    const fechaFin = new Date().toISOString().split('T')[0];\r\n\r\n    let tasaAsistencia = 0;\r\n    if (estudianteIds.length > 0 && claseIds.length > 0) {\r\n      // Obtener todas las asistencias de los estudiantes en las clases del docente\r\n      const { data: asistencias, error: asistenciasError } = await supabase\r\n        .from('asistencia')\r\n        .select('estado')\r\n        .in('estudiante_id', estudianteIds)\r\n        .in('clase_id', claseIds)\r\n        .gte('fecha', fechaInicio)\r\n        .lte('fecha', fechaFin);\r\n\r\n      if (!asistenciasError && asistencias && asistencias.length > 0) {\r\n        const total = asistencias.length;\r\n        const presentes = asistencias.filter(\r\n          a => a.estado === 'presente' || a.estado === 'tarde'\r\n        ).length;\r\n        tasaAsistencia = (presentes / total) * 100;\r\n      }\r\n    }\r\n\r\n    // 4) Calcular promedio general de calificaciones de sus estudiantes\r\n    let promedioGeneral = 0;\r\n    if (estudianteIds.length > 0) {\r\n      const promedios = await Promise.all(\r\n        estudianteIds.map(async (estId) => {\r\n          try {\r\n            return await getPromedioGeneralEstudiante(estId.toString());\r\n          } catch {\r\n            return 0;\r\n          }\r\n        })\r\n      );\r\n\r\n      const promediosValidos = promedios.filter(p => p > 0);\r\n      if (promediosValidos.length > 0) {\r\n        const suma = promediosValidos.reduce((acc, p) => acc + p, 0);\r\n        promedioGeneral = suma / promediosValidos.length;\r\n      }\r\n    }\r\n\r\n    // 5) Mensajes no leídos dirigidos al docente\r\n    const { count: mensajesNoLeidos } = await supabase\r\n      .from('mensajes')\r\n      .select('*', { count: 'exact', head: true })\r\n      .eq('destinatario_tipo', 'docente')\r\n      .eq('destinatario_id', docenteId)\r\n      .eq('leido', false);\r\n\r\n    // 6) Clases de hoy (basado en horario - simplificado: contar clases activas)\r\n    const hoy = new Date();\r\n    const diaSemana = ['domingo', 'lunes', 'martes', 'miércoles', 'jueves', 'viernes', 'sábado'][hoy.getDay()];\r\n    // Por ahora, contamos todas las clases activas (podríamos mejorar esto con horarios reales)\r\n    const clasesHoy = clases.filter(c => c.estado === 'activo').length;\r\n\r\n    // 7) Estudiantes con actividad reciente (últimos 7 días)\r\n    const hace7Dias = new Date();\r\n    hace7Dias.setDate(hace7Dias.getDate() - 7);\r\n    const { data: asistenciasRecientes } = await supabase\r\n      .from('asistencia')\r\n      .select('estudiante_id')\r\n      .in('clase_id', claseIds)\r\n      .gte('fecha', hace7Dias.toISOString().split('T')[0]);\r\n\r\n    const estudiantesRecientes = new Set(\r\n      asistenciasRecientes?.map(a => a.estudiante_id) || []\r\n    ).size;\r\n\r\n    // 8) Calificaciones pendientes (estudiantes sin calificaciones recientes)\r\n    // Por ahora, retornamos 0 (podríamos implementar lógica más compleja)\r\n    const calificacionesPendientes = 0;\r\n\r\n    return {\r\n      totalEstudiantes,\r\n      totalClases: clases.length,\r\n      tasaAsistencia: Math.round(tasaAsistencia * 10) / 10,\r\n      promedioGeneral: Math.round(promedioGeneral * 10) / 10,\r\n      mensajesNoLeidos: mensajesNoLeidos || 0,\r\n      clasesHoy,\r\n      estudiantesRecientes,\r\n      calificacionesPendientes\r\n    };\r\n  } catch (error) {\r\n    console.error('Error al obtener estadísticas del docente:', error);\r\n    throw error;\r\n  }\r\n};\r\n\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}